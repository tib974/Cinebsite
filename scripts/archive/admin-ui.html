<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Admin Sanity CinéB</title>
  <style>
    body { font-family: Arial, sans-serif; background:#0f0f12; color:#f0f0f0; margin:0; padding:24px; }
    .panel { background:#18181f; border:1px solid #272733; border-radius:12px; padding:24px; max-width:520px; margin-bottom:24px; box-shadow:0 6px 22px rgba(0,0,0,0.35); }
    h1 { margin-top:0; }
    label { display:block; margin-bottom:8px; font-weight:600; }
    input[type="email"], select { width:100%; padding:10px 12px; border-radius:8px; border:1px solid #2f2f3a; background:#111118; color:#f0f0f0; }
    button { margin-top:12px; padding:12px 16px; border-radius:999px; border:none; background:#7E57C2; color:#fff; font-weight:700; cursor:pointer; }
    button:disabled { opacity:0.5; cursor:not-allowed; }
    .status { margin-top:16px; font-size:14px; min-height:20px; }
    .status.ok { color:#7be0a2; }
    .status.error { color:#ff8a80; }
    .meta { font-size:13px; color:#a0a0ad; margin-bottom:16px; }
  </style>
</head>
<body>
  <div class="panel">
    <h1>Inviter un collaborateur</h1>
    <div id="meta" class="meta">Chargement des informations…</div>
    <label for="email">Adresse email</label>
    <input id="email" type="email" placeholder="exemple@cineb.re" autocomplete="off" />

    <label for="role">Rôle Sanity</label>
    <select id="role">
      <option value="editor" selected>Editor (édition de contenus)</option>
      <option value="developer">Developer</option>
      <option value="administrator">Administrator</option>
    </select>

    <button id="inviteBtn">Envoyer l’invitation</button>
    <div id="inviteStatus" class="status"></div>
  </div>

  <div class="panel">
    <h2>Déployer Sanity Studio</h2>
    <p class="meta">Relance la commande <code>npm run deploy</code> dans le dossier <code>studio/</code>. Le terminal ouvert lors du démarrage doit rester actif.</p>
    <button id="deployBtn">Déployer le studio</button>
    <div id="deployStatus" class="status"></div>
  </div>

  <script>
    const inviteBtn = document.getElementById('inviteBtn');
    const deployBtn = document.getElementById('deployBtn');
    const inviteStatus = document.getElementById('inviteStatus');
    const deployStatus = document.getElementById('deployStatus');
    const meta = document.getElementById('meta');

    async function fetchStatus() {
      try {
        const res = await fetch('/api/status');
        if (!res.ok) throw new Error('Impossible de récupérer le status');
        const data = await res.json();
        const tokenInfo = data.hasToken ? 'Jeton configuré.' : '⚠️ Aucun jeton trouvé. Ajouter SANITY_ADMIN_TOKEN dans .env.admin';
        meta.textContent = `Projet : ${data.projectId} — Dataset : ${data.dataset}. ${tokenInfo}`;
        if (!data.hasToken) {
          inviteBtn.disabled = true;
        }
      } catch (error) {
        meta.textContent = `Erreur de statut : ${error.message}`;
        inviteBtn.disabled = true;
      }
    }

    fetchStatus();

    inviteBtn.addEventListener('click', async () => {
      inviteStatus.textContent = '';
      inviteStatus.className = 'status';
      const email = document.getElementById('email').value.trim();
      const role = document.getElementById('role').value;

      if (!email) {
        inviteStatus.textContent = 'Merci de renseigner une adresse email.';
        inviteStatus.classList.add('error');
        return;
      }

      inviteBtn.disabled = true;
      inviteStatus.textContent = 'Invitation en cours…';

      try {
        const response = await fetch('/api/invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, role }),
        });
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || 'Erreur inconnue');
        }
        inviteStatus.textContent = `Invitation envoyée à ${email}. (Vérifier la boite mail)`;
        inviteStatus.classList.add('ok');
        document.getElementById('email').value = '';
      } catch (error) {
        inviteStatus.textContent = error.message;
        inviteStatus.classList.add('error');
      } finally {
        inviteBtn.disabled = false;
      }
    });

    deployBtn.addEventListener('click', async () => {
      deployStatus.textContent = '';
      deployStatus.className = 'status';
      deployBtn.disabled = true;
      deployStatus.textContent = 'Déploiement lancé…';

      try {
        const response = await fetch('/api/deploy', { method: 'POST' });
        const payload = await response.json();
        if (!response.ok || !payload.ok) {
          throw new Error(payload.error || 'Erreur inconnue');
        }
        deployStatus.textContent = 'Déploiement en cours. Surveillez le terminal pour suivre les logs.';
        deployStatus.classList.add('ok');
      } catch (error) {
        deployStatus.textContent = error.message;
        deployStatus.classList.add('error');
      } finally {
        deployBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
